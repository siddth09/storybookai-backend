<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Storybook Adventure</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
  .storybook-page { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05); transition: transform 0.3s ease-in-out; transform-style: preserve-3d; }
  .page-transition-next { transform: translateX(-100%); }
  .page-transition-prev { transform: translateX(100%); }
  .loader-dot { animation: pulse 1.5s infinite; }
  .loader-dot:nth-child(2){animation-delay:0.5s;}
  .loader-dot:nth-child(3){animation-delay:1s;}
  @keyframes pulse {0%,100%{opacity:1;}50%{opacity:0.5;}}
</style>
</head>
<body>
<div id="app" class="min-h-screen flex flex-col items-center p-4 sm:p-8">
<h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-6 text-center">
Kid's AI Storybook Studio
</h1>

<div id="input-area" class="w-full max-w-xl bg-white p-6 rounded-xl shadow-lg mb-8">
<p class="text-sm text-gray-500 mb-4">
Tell me what your story is about (e.g., 'A friendly alien who lost his dog on the moon').
</p>
<textarea id="story-prompt" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition resize-none" placeholder="Enter your story idea..."></textarea>
<button id="generate-button" onclick="startGeneration()" class="w-full mt-4 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition shadow-md disabled:bg-gray-400">
Generate My Story!
</button>
</div>

<div id="story-container" class="w-full max-w-4xl relative min-h-[60vh] flex justify-center">
  <div id="loading-state" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-10 hidden rounded-xl shadow-2xl p-8">
    <div class="flex space-x-2">
      <div class="loader-dot w-4 h-4 bg-blue-500 rounded-full"></div>
      <div class="loader-dot w-4 h-4 bg-green-500 rounded-full"></div>
      <div class="loader-dot w-4 h-4 bg-yellow-500 rounded-full"></div>
    </div>
    <p id="loading-message" class="mt-4 text-xl font-semibold text-gray-700 text-center">Generating Story Pages...</p>
    <div id="progress-bar" class="w-full max-w-sm mt-4 h-2 bg-gray-200 rounded-full overflow-hidden">
      <div id="progress-fill" class="h-full bg-blue-500 transition-all duration-500 ease-in-out" style="width:0%;"></div>
    </div>
  </div>

  <div id="page-view" class="storybook-page w-full h-full bg-white rounded-xl shadow-2xl p-4 sm:p-8 flex flex-col hidden">
    <h2 id="story-title" class="text-2xl font-bold text-center text-blue-700 mb-4"></h2>
    <div class="flex-grow flex flex-col sm:flex-row items-center sm:items-start space-y-4 sm:space-y-0 sm:space-x-8">
      <div class="w-full sm:w-1/2 flex justify-center">
        <img id="page-image" src="https://placehold.co/400x300/e0f7fa/00bcd4?text=Illustration+Loading" alt="Story illustration" class="w-full h-auto max-h-[50vh] object-contain rounded-lg border-4 border-blue-100 shadow-md">
      </div>
      <div class="w-full sm:w-1/2 flex flex-col justify-between h-full">
        <div class="text-area">
          <p id="page-number-display" class="text-sm font-medium text-gray-500 mb-2"></p>
          <p id="page-text" class="text-lg text-gray-800 leading-relaxed font-serif"></p>
        </div>
        <div class="mt-6 flex flex-col space-y-3">
          <button id="narration-button" onclick="toggleNarration()" class="py-3 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition shadow-md flex items-center justify-center disabled:bg-gray-400">Read This Page Aloud</button>
          <div class="flex space-x-4">
            <button id="prev-button" onclick="navigateStory(-1)" class="flex-1 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition shadow-md disabled:bg-gray-400 flex items-center justify-center">Previous</button>
            <button id="next-button" onclick="navigateStory(1)" class="flex-1 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 transition shadow-md disabled:bg-gray-400 flex items-center justify-center">Next</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="error-box" class="fixed bottom-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-xl hidden" role="alert">
  <p id="error-text"></p>
</div>

</div>

<script>
let storyData=null, currentPage=0, audioPlayer=new Audio(), isReading=false;

const storyPromptEl=document.getElementById('story-prompt');
const generateButton=document.getElementById('generate-button');
const loadingState=document.getElementById('loading-state');
const loadingMessage=document.getElementById('loading-message');
const pageView=document.getElementById('page-view');
const storyTitleEl=document.getElementById('story-title');
const pageNumberDisplay=document.getElementById('page-number-display');
const pageImage=document.getElementById('page-image');
const pageText=document.getElementById('page-text');
const prevButton=document.getElementById('prev-button');
const nextButton=document.getElementById('next-button');
const narrationButton=document.getElementById('narration-button');
const progressBarFill=document.getElementById('progress-fill');

function showError(message){
    const errorBox=document.getElementById('error-box');
    document.getElementById('error-text').textContent=message;
    errorBox.classList.remove('hidden');
    setTimeout(()=>errorBox.classList.add('hidden'),5000);
    console.error(message);
}

function updateLoading(message, step,totalSteps=15){
    loadingMessage.textContent=message;
    const percent=Math.min(100,Math.round((step/totalSteps)*100));
    progressBarFill.style.width=`${percent}%`;
}

async function startGeneration(){
    const prompt=storyPromptEl.value.trim();
    if(!prompt) return showError("Please enter a story idea!");
    
    storyData=null;
    currentPage=0;
    pageView.classList.add('hidden');
    loadingState.classList.remove('hidden');
    generateButton.disabled=true;
    generateButton.textContent='Generating...';

    let step=0;
    try{
        updateLoading("1/3: Writing story...",step++);
        const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});
        if(!res.ok) throw new Error("Story API failed");
        const storyJson=await res.json();

        for(const page of storyJson.pages){
            const pageNum=page.page_number;
            updateLoading(`2/3: Creating illustration Page ${pageNum}...`,step++);
            const imgRes=await fetch('/api/image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:page.image_prompt})});
            page.imageUrl=(await imgRes.json()).imageUrl;

            updateLoading(`3/3: Generating narration Page ${pageNum}...`,step++);
            const ttsRes=await fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:page.text})});
            page.audioUrl=(await ttsRes.json()).audioUrl;
        }

        storyData=storyJson;
        updateLoading("Story is ready!",15);

        setTimeout(()=>{
            displayPage(1);
            loadingState.classList.add('hidden');
            pageView.classList.remove('hidden');
        },500);

    } catch(e){
        showError(`Generation failed: ${e.message}`);
        loadingState.classList.add('hidden');
        generateButton.disabled=false;
        generateButton.textContent='Generate My Story!';
    }
}

function displayPage(pageNum){
    if(!storyData||!storyData.pages.length)return;
    currentPage=pageNum;
    const pageIndex=pageNum-1;
    const page=storyData.pages[pageIndex];
    stopNarration();
    storyTitleEl.textContent=storyData.title;
    pageNumberDisplay.textContent=`Page ${pageNum} of ${storyData.pages.length}`;
    pageText.textContent=page.text;
    pageImage.src=page.imageUrl||'https://placehold.co/400x300/e0f7fa/00bcd4?text=Image+Not+Available';
    audioPlayer.src=page.audioUrl;
    prevButton.disabled=pageNum===1;
    nextButton.disabled=pageNum===storyData.pages.length;
    narrationButton.disabled=!page.audioUrl;
    toggleNarration(true);
}

function navigateStory(direction){const newPage=currentPage+direction;if(newPage>=1&&newPage<=storyData.pages.length){displayPage(newPage);}}

function toggleNarration(startImmediately=false){if(isReading&&!startImmediately){audioPlayer.pause();isReading=false;narrationButton.textContent='Read This Page Aloud';narrationButton.classList.remove('bg-red-500','hover:bg-red-600');narrationButton.classList.add('bg-yellow-500','hover:bg-yellow-600');} else if(audioPlayer.src){audioPlayer.play().catch(e=>{console.error(e);showError("Could not play audio.")});isReading=true;narrationButton.textContent='Stop Reading';narrationButton.classList.remove('bg-yellow-500','hover:bg-yellow-600');narrationButton.classList.add('bg-red-500','hover:bg-red-600');}}

function stopNarration(){audioPlayer.pause();audioPlayer.currentTime=0;isReading=false;narrationButton.textContent='Read This Page Aloud';narrationButton.classList.remove('bg-red-500','hover:bg-red-600');narrationButton.classList.add('bg-yellow-500','hover:bg-yellow-600');}

audioPlayer.addEventListener('ended',stopNarration);

window.onload=()=>{
prevButton.disabled=true;nextButton.disabled=true;narrationButton.disabled=true;
};
</script>
</body>
</html>
